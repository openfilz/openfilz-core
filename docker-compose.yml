# OpenFilz Docker Compose Configuration
#
# This file starts all services required for OpenFilz.
# Use profiles to enable/disable optional services:
#
# Base services (always started):
#   - postgres: PostgreSQL database
#   - openfilz-api: Backend API service
#   - openfilz-web: Frontend web application
#
# Optional services (use --profile to enable):
#   - auth: Keycloak authentication server (when openfilz.security.no-auth=false)
#   - onlyoffice: OnlyOffice Document Server (when onlyoffice.enabled=true)
#   - fulltext: OpenSearch for full-text search (when openfilz.full-text.active=true)
#
# Examples:
#   Start base services only (no authentication):
#     docker-compose up -d
#
#   Start with Keycloak authentication:
#     docker-compose --profile auth up -d
#
#   Start with OnlyOffice:
#     docker-compose --profile onlyoffice up -d
#
#   Start with OpenSearch full-text search:
#     docker-compose --profile fulltext up -d
#
#   Start all services:
#     docker-compose --profile auth --profile onlyoffice --profile fulltext up -d

networks:
  openfilz-network:
    driver: bridge

volumes:
  postgres-data:
  openfilz-storage:
  opensearch-data:
  keycloak-data:

services:
  # =============================================================================
  # PostgreSQL Database (Always required)
  # =============================================================================
  postgres:
    image: postgres:latest
    container_name: openfilz-postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${DB_NAME:-dms_db}
      POSTGRES_USER: ${DB_USER:-dms_user}
      POSTGRES_PASSWORD: ${DB_PASSWORD:-dms_password}
    volumes:
      - postgres-data:/var/lib/postgresql/data
    ports:
      - "${DB_PORT:-5432}:5432"
    networks:
      - openfilz-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER:-dms_user} -d ${DB_NAME:-dms_db}"]
      interval: 10s
      timeout: 5s
      retries: 5

  # =============================================================================
  # OpenFilz API (Backend)
  # =============================================================================
  openfilz-api:
    image: ${OPENFILZ_API_IMAGE:-ghcr.io/openfilz/openfilz-api:latest}
    container_name: openfilz-api
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      # Database configuration
      DB_HOST: postgres
      DB_PORT: 5432
      DB_NAME: ${DB_NAME:-dms_db}
      DB_USER: ${DB_USER:-dms_user}
      DB_PASSWORD: ${DB_PASSWORD:-dms_password}

      # Storage configuration
      STORAGE_TYPE: ${STORAGE_TYPE:-local}
      STORAGE_LOCAL_BASE_PATH: /var/data/openfilz

      # Security configuration
      # Set to 'false' and use --profile auth to enable Keycloak
      OPENFILZ_SECURITY_NO_AUTH: ${OPENFILZ_SECURITY_NO_AUTH:-false}
      KEYCLOAK_ISSUER_URI: ${KEYCLOAK_ISSUER_URI:-http://keycloak:8080/realms/your-realm}

      # OnlyOffice configuration
      # Set to 'true' and use --profile onlyoffice to enable OnlyOffice
      ONLYOFFICE_ENABLED: ${ONLYOFFICE_ENABLED:-false}
      ONLYOFFICE_URL: ${ONLYOFFICE_URL:-http://onlyoffice}
      ONLYOFFICE_API_BASE_URL: ${ONLYOFFICE_API_BASE_URL:-http://openfilz-api:8081}
      ONLYOFFICE_JWT_SECRET: ${ONLYOFFICE_JWT_SECRET:-openfilz-onlyoffice-jwt-secret-2024}

      # Full-text search configuration
      # Set to 'true' and use --profile fulltext to enable OpenSearch
      OPENFILZ_FULLTEXT_ACTIVE: ${OPENFILZ_FULLTEXT_ACTIVE:-false}
      OPENFILZ_FULLTEXT_OPENSEARCH_HOST: opensearch
      OPENFILZ_FULLTEXT_OPENSEARCH_PORT: 9200
      OPENFILZ_FULLTEXT_OPENSEARCH_SCHEME: http

      # CORS configuration
      OPENFILZ_SECURITY_CORS_ALLOWED_ORIGINS: ${CORS_ALLOWED_ORIGINS:-http://localhost:4200,http://localhost:80}

      # Server configuration
      SERVER_PORT: 8081

      # Java options
      JAVA_OPTS: ${JAVA_OPTS:--Xmx512m -Xms256m}
    volumes:
      - openfilz-storage:/var/data/openfilz
    ports:
      - "${API_PORT:-8081}:8081"
    networks:
      - openfilz-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8081/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  # =============================================================================
  # OpenFilz Web (Frontend)
  # =============================================================================
  openfilz-web:
    image: ${OPENFILZ_WEB_IMAGE:-ghcr.io/openfilz/openfilz-web:latest}
    container_name: openfilz-web
    restart: unless-stopped
    depends_on:
      - openfilz-api
    ports:
      - "${WEB_PORT:-4200}:8080"
    volumes:
      - ./ngx-env.js:/usr/share/nginx/html/ngx-env.js:ro
    networks:
      - openfilz-network

  # =============================================================================
  # Keycloak Authentication Server (Optional - use --profile auth)
  # =============================================================================
  keycloak:
    image: quay.io/keycloak/keycloak:latest
    container_name: openfilz-keycloak
    profiles:
      - auth
    restart: unless-stopped
    environment:
      KEYCLOAK_ADMIN: ${KEYCLOAK_ADMIN:-admin}
      KEYCLOAK_ADMIN_PASSWORD: ${KEYCLOAK_ADMIN_PASSWORD:-admin}
      KC_DB: postgres
      KC_DB_URL: jdbc:postgresql://postgres:5432/${DB_NAME:-dms_db}
      KC_DB_USERNAME: ${DB_USER:-dms_user}
      KC_DB_PASSWORD: ${DB_PASSWORD:-dms_password}
      KC_HOSTNAME: ${KEYCLOAK_HOSTNAME:-localhost}
      KC_HOSTNAME_PORT: ${KEYCLOAK_PORT:-8180}
      KC_HTTP_ENABLED: "true"
      KC_HEALTH_ENABLED: "true"
      KC_HOSTNAME_STRICT: "false"
      KC_HOSTNAME_STRICT_BACKCHANNEL: "true"
    command:
      - start-dev
      - --import-realm
    volumes:
      - keycloak-data:/opt/keycloak/data
      # Mount realm configuration if available
      - ./openfilz-api/src/test/resources/keycloak/realm-export.json:/opt/keycloak/data/import/realm-export.json:ro
    ports:
      - "${KEYCLOAK_PORT:-8180}:8080"
      - "${KEYCLOAK_MANAGEMENT_PORT:-9000}:9000"
    networks:
      - openfilz-network
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "exec 3<>/dev/tcp/127.0.0.1/9000;echo -e 'GET /health/ready HTTP/1.1\r\nhost: localhost\r\nConnection: close\r\n\r\n' >&3;if [ $? -eq 0 ]; then echo 'Healthcheck Successful';exit 0;else echo 'Healthcheck Failed';exit 1;fi;"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  # =============================================================================
  # OnlyOffice Document Server (Optional - use --profile onlyoffice)
  # =============================================================================
  onlyoffice:
    image: onlyoffice/documentserver:latest
    container_name: openfilz-onlyoffice
    profiles:
      - onlyoffice
    restart: unless-stopped
    environment:
      JWT_ENABLED: "true"
      JWT_SECRET: ${ONLYOFFICE_JWT_SECRET:-openfilz-onlyoffice-jwt-secret-2024}
      JWT_HEADER: Authorization
      # Allow connections from OpenFilz containers
      ALLOW_META_IP_ADDRESS: "true"
      ALLOW_PRIVATE_IP_ADDRESS: "true"
    ports:
      - "${ONLYOFFICE_PORT:-8080}:80"
    networks:
      - openfilz-network
    # OnlyOffice needs to reach the API for document downloads
    extra_hosts:
      - "host.docker.internal:host-gateway"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/healthcheck"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s

  # =============================================================================
  # OpenSearch for Full-Text Search (Optional - use --profile fulltext)
  # =============================================================================
  opensearch:
    image: opensearchproject/opensearch:latest
    container_name: openfilz-opensearch
    profiles:
      - fulltext
    restart: unless-stopped
    environment:
      cluster.name: openfilz-cluster
      node.name: opensearch-node1
      discovery.type: single-node
      bootstrap.memory_lock: "true"
      OPENSEARCH_JAVA_OPTS: "-Xms512m -Xmx512m"
      DISABLE_SECURITY_PLUGIN: "true"  # Disable security for development
      DISABLE_INSTALL_DEMO_CONFIG: "true"
    ulimits:
      memlock:
        soft: -1
        hard: -1
      nofile:
        soft: 65536
        hard: 65536
    volumes:
      - opensearch-data:/usr/share/opensearch/data
    ports:
      - "${OPENSEARCH_PORT:-9200}:9200"
      - "${OPENSEARCH_PERF_PORT:-9600}:9600"
    networks:
      - openfilz-network
    healthcheck:
      test: ["CMD-SHELL", "curl -s http://localhost:9200/_cluster/health | grep -q '\"status\":\"green\"\\|\"status\":\"yellow\"'"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  # =============================================================================
  # OpenSearch Dashboards (Optional - use --profile fulltext)
  # Provides a UI to explore OpenSearch data
  # =============================================================================
  opensearch-dashboards:
    image: opensearchproject/opensearch-dashboards:latest
    container_name: openfilz-opensearch-dashboards
    profiles:
      - fulltext
    restart: unless-stopped
    environment:
      OPENSEARCH_HOSTS: '["http://opensearch:9200"]'
      DISABLE_SECURITY_DASHBOARDS_PLUGIN: "true"
    ports:
      - "${OPENSEARCH_DASHBOARDS_PORT:-5601}:5601"
    networks:
      - openfilz-network
    depends_on:
      opensearch:
        condition: service_healthy
