# =============================================================================
# OpenFilz mTLS Configuration
# =============================================================================
#
# This file enables mutual TLS (mTLS) authentication between ImgProxy and
# openfilz-api. ImgProxy will present a client certificate when fetching
# images from openfilz-api, and openfilz-api will validate it.
#
# Prerequisites:
#   1. Generate certificates first:
#      cd certs && ./generate-mtls-certs.sh  (Linux/Mac)
#      cd certs && generate-mtls-certs.bat   (Windows)
#
# Usage:
#   Full deployment with mTLS:
#     docker-compose -f docker-compose.yml -f docker-compose-thumbnails.yml -f docker-compose-mtls.yml --profile thumbnails --profile mtls up -d
#
#   Development (API in IDE, only ImgProxy/Gotenberg in Docker):
#     docker-compose -f docker-compose-imgproxy-dev.yml -f docker-compose-mtls.yml --profile mtls-dev up -d
#
# How it works:
#   1. openfilz-api runs on HTTPS (port 8443) with client certificate authentication
#   2. ImgProxy presents its client certificate when fetching source images
#   3. openfilz-api validates the certificate CN matches "imgproxy.*" pattern
#   4. The /api/v1/thumbnails/source/* endpoint is protected by mTLS
#
# Certificate files (generated by scripts in certs/):
#   - certs/server/server.p12      - Server keystore for openfilz-api
#   - certs/client/imgproxy.crt    - Client certificate for ImgProxy
#   - certs/client/imgproxy.key    - Client private key for ImgProxy
#   - certs/ca/ca.crt              - CA certificate (for verification)
#   - certs/truststore/truststore.p12 - Truststore for openfilz-api
#
# =============================================================================

services:
  # =============================================================================
  # ImgProxy with mTLS Client Certificate (Full deployment)
  # =============================================================================
  imgproxy:
    profiles:
      - mtls
    volumes:
      # Mount client certificate and key
      - ./certs/client/imgproxy.crt:/certs/client.crt:ro
      - ./certs/client/imgproxy.key:/certs/client.key:ro
      # Mount CA certificate for server verification
      - ./certs/ca/ca.crt:/certs/ca.crt:ro
    environment:
      # Client certificate for mTLS authentication to openfilz-api
      IMGPROXY_NETWORK_SSL_CERT_PATH: "/certs/client.crt"
      IMGPROXY_NETWORK_SSL_KEY_PATH: "/certs/client.key"
      # CA certificate to verify openfilz-api's server certificate
      IMGPROXY_NETWORK_SSL_ROOT_CERT_PATH: "/certs/ca.crt"
      # Skip server certificate verification (set to false in production)
      # IMGPROXY_NETWORK_SSL_INSECURE_SKIP_VERIFY: "false"

  # =============================================================================
  # ImgProxy with mTLS Client Certificate (Development mode)
  # Use this when running openfilz-api from IDE
  # =============================================================================
  imgproxy-mtls-dev:
    image: darthsim/imgproxy:latest
    container_name: openfilz-imgproxy-mtls-dev
    profiles:
      - mtls-dev
    restart: unless-stopped
    volumes:
      # Mount client certificate and key
      - ./certs/client/imgproxy.crt:/certs/client.crt:ro
      - ./certs/client/imgproxy.key:/certs/client.key:ro
      # Mount CA certificate for server verification
      - ./certs/ca/ca.crt:/certs/ca.crt:ro
    environment:
      # Server configuration
      IMGPROXY_BIND: ":8080"

      # Client certificate for mTLS authentication
      IMGPROXY_NETWORK_SSL_CERT_PATH: "/certs/client.crt"
      IMGPROXY_NETWORK_SSL_KEY_PATH: "/certs/client.key"
      # CA certificate to verify openfilz-api's server certificate
      IMGPROXY_NETWORK_SSL_ROOT_CERT_PATH: "/certs/ca.crt"

      # PDF support
      IMGPROXY_ENABLE_PDF_PAGES: "true"
      IMGPROXY_PDF_PAGES: "true"

      # SVG support
      IMGPROXY_ENABLE_SVG_SANITIZATION: "false"
      IMGPROXY_SVG_FIX_UNSUPPORTED: "true"

      # Output format
      IMGPROXY_PREFERRED_FORMATS: "png"

      # Skip unsupported formats
      IMGPROXY_SKIP_UNSUPPORTED_FORMATS: "true"

      # Development settings - allow local connections
      IMGPROXY_ALLOW_INSECURE_SOURCE_URL: "false"  # Disabled for mTLS
      IMGPROXY_ALLOW_LOOPBACK_SOURCE_ADDRESSES: "true"
      IMGPROXY_ALLOW_PRIVATE_SOURCE_ADDRESSES: "true"

      # CORS
      IMGPROXY_ALLOW_ORIGIN: "*"

      # Memory limits
      IMGPROXY_MAX_SRC_RESOLUTION: "50"
      IMGPROXY_MAX_SRC_FILE_SIZE: "52428800"

      # Concurrency
      IMGPROXY_CONCURRENCY: "10"
      IMGPROXY_MAX_CLIENTS: "200"

      # Logging
      IMGPROXY_LOG_LEVEL: "info"
    ports:
      - "8082:8080"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s

  # =============================================================================
  # OpenFilz API with mTLS enabled (Full deployment)
  # =============================================================================
  # With dual-port configuration:
  #   - HTTP  on port 8081 (for browser/frontend)
  #   - HTTPS on port 8443 (for ImgProxy mTLS)
  # =============================================================================
  openfilz-api:
    profiles:
      - mtls
    volumes:
      # Mount server keystore
      - ./certs/server/server.p12:/certs/server.p12:ro
      # Mount truststore for client certificate validation
      - ./certs/truststore/truststore.p12:/certs/truststore.p12:ro
      # Mount CA certificate
      - ./certs/ca/ca.crt:/certs/ca.crt:ro
    environment:
      # Enable mTLS - this starts a secondary HTTPS server on port 8443
      # The main HTTP server continues on port 8081
      OPENFILZ_THUMBNAIL_MTLS_ACCESS_ENABLED: "true"
      OPENFILZ_THUMBNAIL_MTLS_ACCESS_TRUSTSTORE_PATH: "/certs/truststore.p12"
      OPENFILZ_THUMBNAIL_MTLS_ACCESS_TRUSTSTORE_PASSWORD: "${SSL_TRUSTSTORE_PASSWORD:-changeit}"
      OPENFILZ_THUMBNAIL_MTLS_ACCESS_ALLOWED_DN_PATTERN: "CN=imgproxy.*"

      # mTLS server configuration
      OPENFILZ_MTLS_PORT: "8443"
      OPENFILZ_MTLS_KEYSTORE_PATH: "/certs/server.p12"
      OPENFILZ_MTLS_KEYSTORE_PASSWORD: "${SSL_KEYSTORE_PASSWORD:-serverpass}"
      OPENFILZ_MTLS_TRUSTSTORE_PATH: "/certs/truststore.p12"
      OPENFILZ_MTLS_TRUSTSTORE_PASSWORD: "${SSL_TRUSTSTORE_PASSWORD:-changeit}"
      OPENFILZ_MTLS_CLIENT_AUTH: "want"

      # Internal API URL uses HTTPS for ImgProxy
      OPENFILZ_INTERNAL_API_BASE_URL: "https://openfilz-api:8443"
    ports:
      - "${API_PORT:-8081}:8081"
      - "${API_HTTPS_PORT:-8443}:8443"

# =============================================================================
# Network configuration for mTLS
# =============================================================================
networks:
  openfilz-network:
    driver: bridge
