# OpenFilz Thumbnail Generation Docker Compose Configuration
#
# This file adds Gotenberg for thumbnail generation.
# Use in combination with the main docker-compose.yml.
#
# Services:
#   - Gotenberg: PDF and Office document conversion (DOCX, XLSX, PPTX, ODT, etc.)
#   - PDFBox (in-process): Renders PDF pages as images
#
# Usage:
#   Start with thumbnail support (local mode):
#     docker-compose -f docker-compose.yml -f docker-compose-thumbnails.yml --profile thumbnails up -d
#
#
# Configuration:
#   Set OPENFILZ_THUMBNAIL_ACTIVE=true to enable thumbnail generation.
#   The API will call Gotenberg for documents.

volumes:
  redis-data:

services:
  # =============================================================================
  # Gotenberg - For PDF and Office Document Thumbnails
  # Converts DOCX, XLSX, PPTX, ODT, ODS, ODP to PDF using LibreOffice
  # =============================================================================
  gotenberg:
    image: gotenberg/gotenberg:8
    container_name: openfilz-gotenberg
    profiles:
      - thumbnails
    restart: unless-stopped
    command:
      - "gotenberg"
      - "--api-timeout=60s"
      - "--libreoffice-restart-after=100"
      - "--libreoffice-auto-start=true"
      - "--log-level=info"
    ports:
      - "${GOTENBERG_PORT:-8083}:3000"
    networks:
      - openfilz-network
    # Allow Gotenberg to reach the host machine (for local development)
    extra_hosts:
      - "host.docker.internal:host-gateway"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # =============================================================================
  # OpenFilz API - Extended Configuration for Thumbnails
  # =============================================================================
  openfilz-api:
    environment:
      # Thumbnail configuration
      OPENFILZ_THUMBNAIL_ACTIVE: ${OPENFILZ_THUMBNAIL_ACTIVE:-true}
      OPENFILZ_THUMBNAIL_API_BASE_URL: ${OPENFILZ_THUMBNAIL_API_BASE_URL:-http://openfilz-api:8081}
      GOTENBERG_URL: ${GOTENBERG_URL:-http://gotenberg:3000}

    depends_on:
      gotenberg:
        condition: service_healthy
