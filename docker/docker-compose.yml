# OpenFilz Docker Compose - Base Configuration
#
# This file contains the core services required to run OpenFilz.
# Use overlay files to add optional features:
#
#   docker-compose -f docker-compose.yml -f docker-compose.auth.yml up -d
#
# Or use the Makefile for convenience:
#
#   make up          # Base only
#   make up-auth     # Base + Keycloak
#   make up-full     # All services

networks:
  openfilz-network:
    driver: bridge

volumes:
  postgres-data:
  openfilz-storage:

services:
  # =============================================================================
  # PostgreSQL Database
  # =============================================================================
  postgres:
    image: ${POSTGRES_IMAGE:-postgres:16}
    container_name: openfilz-postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${DB_NAME:-dms_db}
      POSTGRES_USER: ${DB_USER:-dms_user}
      POSTGRES_PASSWORD: ${DB_PASSWORD:-dms_password}
    volumes:
      - postgres-data:/var/lib/postgresql/data
    ports:
      - "${DB_PORT:-5432}:5432"
    networks:
      - openfilz-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER:-dms_user} -d ${DB_NAME:-dms_db}"]
      interval: 10s
      timeout: 5s
      retries: 5

  # =============================================================================
  # OpenFilz API (Backend)
  # =============================================================================
  openfilz-api:
    image: ${OPENFILZ_API_IMAGE:-ghcr.io/openfilz/openfilz-api:latest}
    container_name: openfilz-api
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      # Database configuration
      DB_HOST: postgres
      DB_PORT: 5432
      DB_NAME: ${DB_NAME:-dms_db}
      DB_USER: ${DB_USER:-dms_user}
      DB_PASSWORD: ${DB_PASSWORD:-dms_password}

      # Storage configuration (local by default)
      STORAGE_TYPE: ${STORAGE_TYPE:-local}
      STORAGE_LOCAL_BASE_PATH: /var/data/openfilz

      # Security configuration (no-auth by default for development)
      OPENFILZ_SECURITY_NO_AUTH: ${OPENFILZ_SECURITY_NO_AUTH:-true}

      # CORS configuration
      OPENFILZ_SECURITY_CORS_ALLOWED_ORIGINS: ${CORS_ALLOWED_ORIGINS:-http://localhost:4200,http://localhost:80}

      # Server configuration
      SERVER_PORT: 8081

      # Java options
      JAVA_OPTS: ${JAVA_OPTS:--Xmx512m -Xms256m}

      # Flyway configuration - ensure migrations run from V1_0
      SPRING_FLYWAY_BASELINE_ON_MIGRATE: "true"
      SPRING_FLYWAY_BASELINE_VERSION: "0"
    volumes:
      - openfilz-storage:/var/data/openfilz
    ports:
      - "${API_PORT:-8081}:8081"
    networks:
      - openfilz-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8081/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  # =============================================================================
  # OpenFilz Web (Frontend)
  # =============================================================================
  openfilz-web:
    image: ${OPENFILZ_WEB_IMAGE:-ghcr.io/openfilz/openfilz-web:latest}
    container_name: openfilz-web
    restart: unless-stopped
    depends_on:
      - openfilz-api
    ports:
      - "${WEB_PORT:-4200}:8080"
    volumes:
      - ./ngx-env.js:/usr/share/nginx/html/ngx-env.js:ro
    networks:
      - openfilz-network
