# src/main/resources/application.yml
spring:
  application:
    name: openfilz-api
  threads:
    virtual:
      enabled: true
  r2dbc:
    url: r2dbc:postgresql://${DB_HOST:localhost}:${DB_PORT:5432}/${DB_NAME:dms_db}
    username: ${DB_USER:dms_user}
    password: ${DB_PASSWORD:dms_password}
    initialization-mode: always
    pool:
      enabled: true
      initial-size: 5
      max-size: 10
  flyway:
    url: jdbc:postgresql://${DB_HOST:localhost}:${DB_PORT:5432}/${DB_NAME:dms_db}
    user: ${DB_USER:dms_user}
    password: ${DB_PASSWORD:dms_password}
    locations: classpath:db/migration
    baseline-on-migrate: true
    out-of-order: true

  security:
    oauth2:
      resourceserver:
        jwt:
          jwk-set-uri: ${KEYCLOAK_REALM_URL:http://localhost:8180/realms/openfilz}/protocol/openid-connect/certs

  sql:
    init:
      mode: always

  graphql:
    http:
      path: /graphql/v1

# Storage Configuration
storage:
  type: local # local or minio
  local:
    base-path: /tmp/dms-storage
  minio:
    endpoint: ${MINIO_ENDPOINT:http://localhost:9000}
    access-key: ${MINIO_ACCESS_KEY:minioadmin}
    secret-key: ${MINIO_SECRET_KEY:minioadmin}
    bucket-name: ${MINIO_BUCKET_NAME:dms-bucket}

# Swagger / OpenAPI
openapi:
  service:
    title: openfilz-api
    url: ${API_ROOT_URL:http://localhost:8081/} # put http://localhost:8081/ for standalone usage & http://localhost:8888/dms-api if the openfilz-gateway is used
    version: 1.0.0

springdoc:
  api-docs:
    path: /v3/api-docs # put /v3/api-docs for standalone usage & /dms-api/v3/api-docs if the openfilz-gateway is used
  swagger-ui:
    path: /swagger-ui.html # put /swagger-ui.html for standalone usage & /dms-api/swagger-ui.html if the openfilz-gateway is used

# Logging for auditing (can be more sophisticated)
logging:
  level:
    org.openfilz: DEBUG
    io.r2dbc.postgresql.QUERY: DEBUG # for queries
    # io.r2dbc.postgresql.PARAM: DEBUG # for parameters
    # org.springframework.security: TRACE

server:
  port: 8081

# Buffer size for PipedInputStreams
piped:
  buffer:
    size: 8192

openfilz:
 #  calculate-checksum: default false - if true : calculate checksum of each new or modified file
 #  full-text:
 #openfilz.full-text.opensearch.host=localhost
  #openfilz.full-text.opensearch.port=9200
  #openfilz.full-text.opensearch.scheme=http
  #openfilz.full-text.opensearch.username=admin # Si authentification de base
  #openfilz.full-text.opensearch.password=admin # Si authentification de base
 #    active: default : false
 #    indexation-mode: local # local (only choice for the moment) -> to be developed : redis | kafka | nats
 #    custom-index-service: default : false - if true : the
 #    opensearch:  # URL of the OpenSearch Cluster used to perform full text search
 #      url: http://localhost:9200
  security:
    no-auth: true # No authentication required
    # worm-mode: default false - if true : only read-only endPoints (for list, query and download) and upload (and upload-multiple) endPoints are accessible
    # custom-roles: default false - if true : you can provide a custom implementation of org.openfilz.dms.config.DefaultAuthSecurityConfig and org.openfilz.dms.security.impl.SecurityServiceImpl
    # cors-allowed-origins: http://localhost:4200/ # Comma-separated list of authorized origins
    # role-token-lookup: GROUPS or REALM_ACCESS (default value) : optional value used in org.openfilz.dms.security.impl.AbstractSecurityService to retrieve Role information from Groups or from the Realm_access
    # role-token-lookup: GROUPS
    # root-group: name of the root group holding the 3 Roles as subgroups : eg. 'GED' is the root group in the group /GED/AUDITORS
    # root-group: GED
  soft-delete:
    active: false

# OnlyOffice DocumentServer Integration
onlyoffice:
  enabled: ${ONLYOFFICE_ENABLED:false}
  document-server:
    url: ${ONLYOFFICE_URL:http://localhost}
    api-path: /web-apps/apps/api/documents/api.js
  # URL that OnlyOffice DocumentServer uses to reach OpenFilz API
  # Use host.docker.internal when OnlyOffice runs in Docker and OpenFilz runs on host
  api-base-url: ${ONLYOFFICE_API_BASE_URL:http://host.docker.internal:8081}
  jwt:
    enabled: true
    secret: ${ONLYOFFICE_JWT_SECRET:openfilz-onlyoffice-jwt-secret-2024}
  supported-extensions:
    - docx
    - doc
    - xlsx
    - xls
    - pptx
    - ppt
    - odt
    - ods
    - odp
    - pdf

# Database schema initialization (e.g., Flyway or Liquibase if preferred)
# For simple R2DBC, you might use an InitializingBean to create tables
# Example:
# spring.sql.init.mode=always
# spring.sql.init.schema-locations=classpath:schema.sql
